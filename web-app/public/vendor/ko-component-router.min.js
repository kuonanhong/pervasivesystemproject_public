!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("knockout")):"function"==typeof define&&define.amd?define("ko-component-router",["knockout"],e):(t.ko=t.ko||{},t.ko.router=e(t.ko))}(this,function(t){"use strict";function e(t){return S(t)===!0&&"[object Object]"===Object.prototype.toString.call(t)}function n(t){return"function"==typeof t.splice}function r(t){return"boolean"==typeof t}function i(t){return T(t)}function o(t){return"string"==typeof t}function u(t){return"function"==typeof t}function a(t){return"undefined"==typeof t}function c(t,e){return t.reduce(function(t,r){var i=e(r);return t.concat(n(i)?i:[i])},[])}function s(t){for(var e=this,n=[],r=arguments.length-1;r-- >0;)n[r]=arguments[r+1];var i=[];return t=t.map(function(t){var r=l(t).apply(void 0,n),o=function(){return new Promise(function(t,e){var n;return n=r.next(),new Promise(function(t,e){return f(n)?n.then(t,e):t(n.value)}.bind(this)).then(function(r){try{return n=r,t(n||!0)}catch(i){return e(i)}}.bind(this),e)}.bind(e))};return i.push(o),o}),[h.apply(void 0,[t].concat(n)),function(){return h.apply(void 0,[i].concat(n))}]}function h(t){for(var e=[],n=arguments.length-1;n-- >0;)e[n]=arguments[n+1];return new Promise(function(n,r){function i(){return(c[1]=c[0].next()).done||(u=c[1].value,0)?[1]:d(u).apply(void 0,e).then(function(t){try{return t===!1?n(!1):i}catch(e){return r(e)}}.bind(this),r)}function o(){return n()}var u,a,c=[t[Symbol.iterator]()];return(a=function(t){for(var e=this;t;){if(t.then)return void t.then(a,r);try{if(t.pop){if(t.length)return t.pop()?o.call(e):t;t=i}else t=t.call(e)}catch(n){return r(n)}}}.bind(this))(i)}.bind(this))}function p(t){return"GeneratorFunction"===t.constructor.name}function f(t){return!a(t)&&u(t.then)}function l(t){return p(t)?t:function(){for(var e=[],n=arguments.length;n--;)e[n]=arguments[n];var r,i=1;return{next:function(){return new Promise(function(n,o){switch(i++){case 1:return d(t).apply(void 0,e).then(function(t){try{return r=t||!1,new Promise(function(t,e){return r&&r.beforeRender?d(r.beforeRender)().then(t,e):t(r)}.bind(this)).then(n,o)}catch(e){return o(e)}}.bind(this),o);case 2:return new Promise(function(t,e){function n(){return t(i)}var i;return(i=r)?d(r.afterRender)().then(function(t){try{return i=t,n.call(this)}catch(r){return e(r)}}.bind(this),e):n.call(this)}.bind(this)).then(n,o);case 3:return new Promise(function(t,e){function n(){return t(i)}var i;return(i=r)?d(r.beforeDispose)().then(function(t){try{return i=t,n.call(this)}catch(r){return e(r)}}.bind(this),e):n.call(this)}.bind(this)).then(n,o);case 4:return new Promise(function(t,e){function n(){return t(i)}var i;return(i=r)?d(r.afterDispose)().then(function(t){try{return i=t,n.call(this)}catch(r){return e(r)}}.bind(this),e):n.call(this)}.bind(this)).then(n,o)}return n()}.bind(this))}}}}function d(t){var e=this;return void 0===t&&(t=function(){}),function(){for(var n=[],r=arguments.length;r--;)n[r]=arguments[r];return new Promise(function(e,r){var i,o;return i=function(){return t.length===n.length+1?new Promise(function(e){t.apply(void 0,n.concat([e]))}):t.apply(void 0,n)},o=i(),new Promise(function(t,e){return f(o)?o.then(t,e):t(o)}.bind(this)).then(e,r)}.bind(e))}}function b(t,e){for(var n,r=[],i=0,o=0,u="",a=e&&e.delimiter||"/";null!=(n=J.exec(t));){var c=n[0],s=n[1],h=n.index;if(u+=t.slice(o,h),o=h+c.length,s)u+=s[1];else{var p=t[o],f=n[2],l=n[3],d=n[4],b=n[5],v=n[6],g=n[7];u&&(r.push(u),u="");var m=null!=f&&null!=p&&p!==f,y="+"===v||"*"===v,x="?"===v||"*"===v,$=n[2]||a,_=d||b;r.push({name:l||i++,prefix:f||"",delimiter:$,optional:x,repeat:y,partial:m,asterisk:!!g,pattern:_?k(_):g?".*":"[^"+w($)+"]+?"})}}return o<t.length&&(u+=t.substr(o)),u&&r.push(u),r}function v(t,e){return y(b(t,e))}function g(t){return encodeURI(t).replace(/[\/?#]/g,function(t){return"%"+t.charCodeAt(0).toString(16).toUpperCase()})}function m(t){return encodeURI(t).replace(/[?#]/g,function(t){return"%"+t.charCodeAt(0).toString(16).toUpperCase()})}function y(t){for(var e=new Array(t.length),n=0;n<t.length;n++)"object"==typeof t[n]&&(e[n]=new RegExp("^(?:"+t[n].pattern+")$"));return function(n,r){for(var i="",o=n||{},u=r||{},a=u.pretty?g:encodeURIComponent,c=0;c<t.length;c++){var s=t[c];if("string"!=typeof s){var h,p=o[s.name];if(null==p){if(s.optional){s.partial&&(i+=s.prefix);continue}throw new TypeError('Expected "'+s.name+'" to be defined')}if(z(p)){if(!s.repeat)throw new TypeError('Expected "'+s.name+'" to not repeat, but received `'+JSON.stringify(p)+"`");if(0===p.length){if(s.optional)continue;throw new TypeError('Expected "'+s.name+'" to not be empty')}for(var f=0;f<p.length;f++){if(h=a(p[f]),!e[c].test(h))throw new TypeError('Expected all "'+s.name+'" to match "'+s.pattern+'", but received `'+JSON.stringify(h)+"`");i+=(0===f?s.prefix:s.delimiter)+h}}else{if(h=s.asterisk?m(p):a(p),!e[c].test(h))throw new TypeError('Expected "'+s.name+'" to match "'+s.pattern+'", but received "'+h+'"');i+=s.prefix+h}}else i+=s}return i}}function w(t){return t.replace(/([.+*?=^!:${}()[\]|\/\\])/g,"\\$1")}function k(t){return t.replace(/([=!:$\/()])/g,"\\$1")}function x(t,e){return t.keys=e,t}function $(t){return t.sensitive?"":"i"}function _(t,e){var n=t.source.match(/\((?!\?)/g);if(n)for(var r=0;r<n.length;r++)e.push({name:r,prefix:null,delimiter:null,optional:!1,repeat:!1,partial:!1,asterisk:!1,pattern:null});return x(t,e)}function R(t,e,n){for(var r=[],i=0;i<t.length;i++)r.push(E(t[i],e,n).source);var o=new RegExp("(?:"+r.join("|")+")",$(n));return x(o,e)}function P(t,e,n){return C(b(t,n),e,n)}function C(t,e,n){z(e)||(n=e||n,e=[]),n=n||{};for(var r=n.strict,i=n.end!==!1,o="",u=0;u<t.length;u++){var a=t[u];if("string"==typeof a)o+=w(a);else{var c=w(a.prefix),s="(?:"+a.pattern+")";e.push(a),a.repeat&&(s+="(?:"+c+s+")*"),s=a.optional?a.partial?c+"("+s+")?":"(?:"+c+"("+s+"))?":c+"("+s+")",o+=s}}var h=w(n.delimiter||"/"),p=o.slice(-h.length)===h;return r||(o=(p?o.slice(0,-h.length):o)+"(?:"+h+"(?=$))?"),o+=i?"$":r&&p?"":"(?="+h+"|$)",x(new RegExp("^"+o,$(n)),e)}function E(t,e,n){return z(e)||(n=e||n,e=[]),n=n||{},t instanceof RegExp?_(t,e):z(t)?R(t,e,n):P(t,e,n)}function O(t,e){var n=D(t,e),r=n[0],i=n[1];return r.base+i}function A(t,e){var n=D(t,e),r=n[0],i=n[1];return!r.isNavigating()&&(r.ctx.pathname||"/")==="/"+i.split("/")[1]}function D(t,e){var n=j(t);if(0===e.indexOf("//"))for(e=e.replace("//","/");!n.isRoot;)n=n.$parent;else for(0===e.indexOf("./")&&(e=e.replace("./","/"),n=n.$child);e&&e.match(/\/?\.\./i)&&!n.isRoot;)n=n.$parent,e=e.replace(/\/?\.\./i,"");return[n,e]}function j(t){for(;!a(t);){if(!a(t.$router))return t.$router;t=t.$parentContext}return X.get(0)}function N(e){function n(n){t.isObservable(e[n])&&(console.warn("\n        [ko-component-router] `params."+n+"` was passed in as an observable.\n        It willbe unwrapped, but changes will NOT be observed.\n    "),e[n]=t.unwrap(e[n]))}return n("routes"),n("base"),n("hashbang"),e}t="default"in t?t["default"]:t;var B=function(t){return null!=t&&"object"==typeof t&&!Array.isArray(t)},S=B,T=function(t){var n,r;return e(t)!==!1&&(n=t.constructor,"function"==typeof n&&(r=n.prototype,e(r)!==!1&&r.hasOwnProperty("isPrototypeOf")!==!1))},L=function(t){Object.assign(this,t),this.fullPath=this.router.base+this.pathname,this.canonicalPath=this.fullPath.replace(new RegExp(this.router.$root.base,"i"),""),this._queue=[],this._beforeNavigateCallbacks=[],this._afterRenderCallbacks=[],this._beforeDisposeCallbacks=[],this._afterDisposeCallbacks=[]},U={$parent:{},$parents:{},$child:{},$children:{},element:{}};L.prototype.addBeforeNavigateCallback=function(t){this._beforeNavigateCallbacks.unshift(t)},U.$parent.get=function(){return this.router.isRoot?void 0:this.router.$parent.ctx},U.$parents.get=function(){return this.router.$parents.map(function(t){return t.ctx})},U.$child.get=function(){return a(this.router.$child)?void 0:this.router.$child.ctx},U.$children.get=function(){return this.router.$children.map(function(t){return t.ctx})},U.element.get=function(){return document.getElementsByClassName("ko-component-router-view")[this.router.depth]},L.prototype.runBeforeNavigateCallbacks=function(){return new Promise(function(t,e){var n,r;for(n=this,r=[];n;)r=n._beforeNavigateCallbacks.concat(r),n=n.$child;return h(r).then(t,e)}.bind(this))},L.prototype.queue=function(t){this._queue.push(t)},L.prototype.flushQueue=function(){return new Promise(function(t,e){var n=this;return t(Promise.all(this._queue).then(function(){return n._queue=[]}))}.bind(this))},L.prototype.runBeforeRender=function(){return new Promise(function(t,e){var n,r,i,o,u;return u=s(X.middleware,this),n=u[0],r=u[1],this._afterRenderCallbacks.push(r),this._beforeDisposeCallbacks.push(r),this._afterDisposeCallbacks.push(r),n.then(function(n){try{var r;return r=s(this.route.middleware,this),i=r[0],o=r[1],this._afterRenderCallbacks.push(o),this._beforeDisposeCallbacks.unshift(o),this._afterDisposeCallbacks.unshift(o),i.then(function(n){try{return this.flushQueue().then(function(n){try{return t()}catch(r){return e(r)}}.bind(this),e)}catch(r){return e(r)}}.bind(this),e)}catch(u){return e(u)}}.bind(this),e)}.bind(this))},L.prototype.runAfterRender=function(){return new Promise(function(t,e){return h(this._afterRenderCallbacks).then(function(n){try{return this.flushQueue().then(function(n){try{return t()}catch(r){return e(r)}}.bind(this),e)}catch(r){return e(r)}}.bind(this),e)}.bind(this))},L.prototype.runBeforeDispose=function(){return new Promise(function(t,e){function n(){return h(this._beforeDisposeCallbacks).then(function(n){try{return this.flushQueue().then(function(n){try{return t()}catch(r){return e(r)}}.bind(this),e)}catch(r){return e(r)}}.bind(this),e)}return this.$child?this.$child.runBeforeDispose().then(function(t){try{return n.call(this)}catch(r){return e(r)}}.bind(this),e):n.call(this)}.bind(this))},L.prototype.runAfterDispose=function(){return new Promise(function(t,e){return h(this._afterDisposeCallbacks).then(function(n){try{return this.flushQueue().then(function(n){try{return t()}catch(r){return e(r)}}.bind(this),e)}catch(r){return e(r)}}.bind(this),e)}.bind(this))},Object.defineProperties(L.prototype,U);var q=Array.isArray||function(t){return"[object Array]"==Object.prototype.toString.call(t)},z=q,F=E,Q=b,I=v,K=y,H=C,J=new RegExp(["(\\\\.)","([\\/.])?(?:(?:\\:(\\w+)(?:\\(((?:\\\\.|[^\\\\()])+)\\))?|\\(((?:\\\\.|[^\\\\()])+)\\))([+*?])?|(\\*))"].join("|"),"g");F.parse=Q,F.compile=I,F.tokensToFunction=K,F.tokensToRegExp=H;var M=function tt(t,e){var r=this;this.middleware=c(n(e)?e:[e],function(t){var e=X.plugins.reduce(function(e,r){var i=r(t);return i?e.concat(n(i)?i:[i]):e},[]);return e.length>0?e:t}).reduce(function(e,n){return o(n)?r.component=n:i(n)?(t=t.replace(/\/?!?$/,"/!"),r.children=Object.entries(n).map(function(t){var e=t[0],n=t[1];return new tt(e,n)}),r.component||(r.component="ko-component-router")):u(n)&&e.push(n),e},[]),t="!"===t[t.length-1]?t.replace("!",":__child_path__(.*)?"):t.replace(/\(?\*\)?/,"(.*)"),this.path=t,this._keys=[],this._regexp=F(t,this._keys)};M.prototype.matches=function et(t){var e=this,et=this._regexp.exec(t);if(null===et)return!1;if(this.children){for(var n=0,r=e.children;n<r.length;n+=1){var i=r[n],o="/"+(et[et.length-1]||"");if(i.matches(o))return!0}return!1}return!0},M.prototype.parse=function(t){for(var e,n=this,r={},i=this._regexp.exec(t),o=1,u=i.length;o<u;++o){var a=n._keys[o-1],c=i[o]||"";"__child_path__"===a.name?e="/"+c:r[a.name]=c}return[r,t.replace(new RegExp(e+"$"),""),e]},M.createRoutes=function(t){return Object.entries(t).map(function(t){var e=t[0],n=t[1];return new M(e,n)})};var G={click:document.ontouchstart?"touchstart":"click",popstate:"popstate"},V=[],W=[],X=function nt(e){var n=this;this.component=t.observable(),this.isNavigating=t.observable(!0),this.routes=M.createRoutes(e.routes||{}),nt.link(this),this.isRoot?(nt.setConfig(e),(r=this.routes).push.apply(r,M.createRoutes(nt.routes)),document.addEventListener(G.click,nt.onclick),window.addEventListener(G.popstate,nt.onpopstate)):this.$parent.ctx.route.children&&(i=this.routes).push.apply(i,this.$parent.ctx.route.children),this.passthrough=Object.entries(e).reduce(function(t,e){var n=e[0],r=e[1];return"base"===n||"hashbang"===n||"routes"===n?t:Object.assign(t,(i={},i[n]=r,i));var i},{}),this.update(this.getPathFromLocation(),!1).then(function(){return V.forEach(function(t){return t(n)})});var r,i},Y={base:{},$parent:{},$parents:{},$child:{},$children:{}},Z={head:{},tail:{},initialized:{}};return Y.base.get=function(){return this.isRoot?X.config.base+(X.config.hashbang?"/#!":""):this.$parent.base+this.$parent.ctx.pathname},Y.$parent.get=function(){return W[this.depth-1]},Y.$parents.get=function(){return W.slice(0,this.depth).reverse()},Y.$child.get=function(){return W[this.depth+1]},Y.$children.get=function(){return W.slice(this.depth+1)},X.prototype.update=function(e,n){return new Promise(function(i,o){function u(){function e(){function e(){return m=c&&c.$children.reverse(),g.runBeforeRender().then(function(e){function n(){return(h[1]=h[0].next()).done||(a=h[1].value,0)?[1]:a.runAfterDispose().then(function(t){try{return n}catch(e){return o(e)}}.bind(this),o)}function r(){return c.runAfterDispose().then(function(t){try{return u.call(this)}catch(e){return o(e)}}.bind(this),o)}function u(){return g.runAfterRender().then(function(t){try{return this.isNavigating(!1),i(!0)}catch(e){return o(e)}}.bind(this),o)}try{if(this.ctx=g,this.component(!1),t.tasks.runEarly(),this.component(this.ctx.route.component),t.tasks.runEarly(),c){var a,s,h=[m[Symbol.iterator]()];return(s=function(t){for(var e=this;t;){if(t.then)return void t.then(s,o);try{if(t.pop){if(t.length)return t.pop()?r.call(e):t;t=n}else t=t.call(e)}catch(i){return o(i)}}}.bind(this))(n)}return u.call(this)}catch(p){return o(p)}}.bind(this),o)}return history[n.push?"pushState":"replaceState"](history.state,document.title,this.base+p+s+h),g=new L(Object.assign({},n["with"],this.passthrough,{router:this,params:l,route:f,path:p,pathname:d})),c?c.runBeforeDispose().then(function(t){try{return e.call(this)}catch(n){return o(n)}}.bind(this),o):e.call(this)}return c?c.runBeforeNavigateCallbacks().then(function(t){try{return v=t,v===!1?i(!1):(this.isNavigating(!0),e.call(this))}catch(n){return o(n)}}.bind(this),o):e.call(this)}var c,s,h,p,f,l,d,b,v,g,m;c=this.ctx,r(n)?n={push:n}:a(n)&&(n={}),a(n.push)&&(n.push=!0),a(n["with"])&&(n["with"]={});var y;if(y=X.parseUrl(e),s=y.search,h=y.hash,p=X.getPath(e),f=this.resolveRoute(p),!f)return i(!1);var w;return w=f.parse(p),l=w[0],d=w[1],b=w[2],c&&c.pathname===d&&!n.force?this.$child?this.$child.update(b+s+h,n).then(i,o):i(!1):u.call(this)}.bind(this))},X.prototype.resolveRoute=function(t){var e,n=this,r=1/0;for(var i in n.routes){var o=n.routes[i];if(o.matches(t)){if(0===o._keys.length)return o;(r===1/0||o._keys.length<r&&".*"!==o._keys[0].pattern)&&(r=o._keys.length,e=o)}}return e},X.prototype.getPathFromLocation=function(){var t=location.pathname+location.search+location.hash,e=this.base.replace("#!","#?!?");return t.replace(new RegExp(e,"i"),"")},X.prototype.dispose=function(){var t=this;X.unlink(),this.isRoot&&(document.removeEventListener(G.click,X.onclick,!1),window.removeEventListener(G.popstate,X.onpopstate,!1),this.ctx.runBeforeDispose().then(function(){return t.ctx.runAfterDispose()}))},X.setConfig=function(t){var e=t.base,n=t.hashbang;e&&(X.config.base=e),n&&(X.config.hashbang=n)},X.use=function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];(n=X.middleware).push.apply(n,t);var n},X.usePlugin=function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];(n=X.plugins).push.apply(n,t);var n},X.useRoutes=function(t){Object.assign(X.routes,t)},X.get=function(t){return W[t]},Z.head.get=function(){return W[0]},Z.tail.get=function(){return W[W.length-1]},Z.initialized.get=function(){return 0===W.length?new Promise(function(t){return V.push(t)}):Promise.resolve(X.head)},X.update=function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];return new Promise(function(e,n){return(r=W[0]).update.apply(r,t).then(e,n);var r}.bind(this))},X.link=function(t){t.depth=W.length,t.isRoot=0===t.depth,W.push(t),t.$root=W[0]},X.unlink=function(){W.pop()},X.onclick=function(t){if(!t.defaultPrevented){for(var e=t.target;e&&"A"!==e.nodeName;)e=e.parentNode;if(e&&"A"===e.nodeName){var n=e.pathname,r=e.search,i=e.hash;void 0===i&&(i="");var o=(n+r+i).replace(new RegExp(W[0].base,"i"),""),u=X.hasRoute(o),a=!X.sameOrigin(e.href),c=1!==X.which(t),s=e.hasAttribute("download"),h="#"===e.getAttribute("href"),p=0===(e.getAttribute("href")||"").indexOf("mailto:"),f="external"===e.getAttribute("rel"),l=t.metaKey||t.ctrlKey||t.shiftKey,d=e.hasAttribute("target");!u||a||c||s||h||p||f||l||d||(X.update(o),t.preventDefault())}}},X.onpopstate=function(t){X.update(W[0].getPathFromLocation(),!1),t.preventDefault()},X.canonicalizePath=function(t){return t.replace(new RegExp("/?#?!?/?"),"/")},X.parseUrl=function(t){var e=document.createElement("a"),n=W[0].base.toLowerCase();return n&&0===t.toLowerCase().indexOf(n)&&(t=t.replace(new RegExp(n,"i"),"")||"/"),e.href=X.canonicalizePath(t),{hash:e.hash,pathname:"/"===e.pathname.charAt(0)?e.pathname:"/"+e.pathname,search:e.search}},X.getPath=function(t){return X.parseUrl(t).pathname},X.hasRoute=function(t){return!a(X.head.resolveRoute(X.getPath(t)))},X.sameOrigin=function(t){var e=location.hostname,n=location.port,r=location.protocol,i=r+"//"+e;return n&&(i+=":"+n),t&&0===t.indexOf(i)},X.which=function(t){return t=t||window.event,null===t.which?t.button:t.which},Object.defineProperties(X.prototype,Y),Object.defineProperties(X,Z),X.config={base:"",hashbang:!1},X.middleware=[],X.plugins=[],X.routes={},t.bindingHandlers.path={init:function(e,n,r,i,o){X.initialized.then(function(){t.tasks.schedule(function(){return t.applyBindingsToNode(e,{attr:{href:t.pureComputed(function(){return O(o,t.unwrap(n()))})},css:{"active-path":t.pureComputed(function(){return A(o,t.unwrap(n()))})}})})})}},t.components.register("ko-component-router",{synchronous:!0,viewModel:{createViewModel:function(t){return new X(N(t))}},template:'<div data-bind="if: component">\n      <div class="ko-component-router-view" data-bind="__ko_component_router__"></div>\n    </div>'}),t.bindingHandlers.__ko_component_router__={init:function(e,n,r,i,o){var u=o.$rawData;return t.applyBindingsToNode(e,{css:u.component,component:{name:u.component,params:u.ctx}},o.extend({$router:u})),{controlsDescendantBindings:!0}}},X});
//# sourceMappingURL=ko-component-router.min.js.map
